import{u as up,a as as,g as gi,a1 as Bt,a2 as Mt,a3 as De,a4 as mi,c as bc,s as st,a5 as $r,f as ai,e as el,a6 as hi,$ as $u,h as Qs,O as Oi,y as yi,J as Ju,i as ie,z as uc,a7 as od,L as ut,a8 as rn}from"./dynamicTag.98ddbc91.js";import{l}from"./use-http.b742b921.9df4e65c.js";import"./vue.4c5758a0.js";import"./@babel.dd651e2b.js";import"./regenerator-runtime.8e24db72.js";import"./@vue.87afd1fa.js";import"./index.97f9c525.js";import"./js-md5.3cdd41c4.js";import"./vue-router.9a2c52dc.js";import"./js-cookie.31874410.js";import"./ant-design-vue.e954adc4.js";import"./@ant-design.8c82b126.js";import"./@ctrl.fa7cbd46.js";import"./resize-observer-polyfill.8deb1e21.js";import"./vue-types.6e6d84ba.js";import"./dom-align.f1b5d360.js";import"./lodash-es.0ea26897.js";import"./dayjs.0743a87f.js";import"./async-validator.5d25c98b.js";import"./scroll-into-view-if-needed.5191fdbf.js";import"./compute-scroll-into-view.6058b3be.js";import"./lodash.28c974ad.js";import"./spark-md5.2cc5764b.js";import"./@vueuse.67682d36.js";import"./vue-demi.24ed2461.js";import"./axios.e3200588.js";/* empty css                     */import"./sortablejs.412b554c.js";import"./clipboard.89482ba1.js";import"./markdown-it.39ce48f9.js";import"./entities.0d2c0164.js";import"./uc.micro.981ceb7b.js";import"./mdurl.ef76b4dc.js";import"./linkify-it.92c30060.js";import"./markdown-it-emoji.e3e91710.js";import"./escape-html.e5dfadb9.js";import"./prismjs.169105cf.js";import"./diacritics.6be19c75.js";import"./markdown-it-container.512a5043.js";import"./markdown-it-anchor.c88e5394.js";import"./markdown-it-attrs.3af5ab50.js";import"./markdown-it-table-of-contents.8a4ce16f.js";import"./@kangc.52338b19.js";const __default__={name:"ExForm",inheritAttrs:!1},_sfc_main=Object.assign(__default__,{props:{url:String,method:{type:String,default:"POST"},exceptField:{type:Array,default:[]},editId:{type:[String,Number],default:null},callParams:{type:Object,default:{}},params:{type:Object,default:{}},tabsValidateField:{type:Array,default:[]},collapseValidateField:{type:Array,default:[]},validateField:{type:Array,default:[]},watchField:{type:Array,default:[]},stepCurrent:[String,Number],enterToTab:Boolean,focusFirst:Boolean},emits:["submit","success","update:stepCurrent","watchModel"],setup(__props,{expose,emit}){const props=__props,attrs=up(),form=as(),originData=submitData();attrs.model;const watchData=[],proxyData=gi(),stepResult=as(null),{loading,http}=l();let enterTabIndex=-1,submitPass=!0,watchCancel=null;Bt(attrs.model,t=>{emit("watchModel",t)},{debounce:300}),props.watchField.forEach(item=>{let field=item.field,watchField=getWatchField(field);const watchValue=eval("attrs.model."+watchField);Mt(watchValue)?Bt(bc(()=>JSON.stringify(eval("attrs.model."+watchField))),(t,e)=>{t!==e&&(t=JSON.parse(t),De(t,props.exceptField),e=JSON.parse(e),field.indexOf(".*.")>-1?mi(t,e,getWatchField(field,!0)).forEach(a=>{watchQueue(field,a.value,a.oldValue,a.index)}):watchQueue(field,t,e))},{debounce:item.debounce,deep:!0}):Bt(()=>eval("attrs.model."+watchField),(t,e)=>{watchQueue(field,t,e)},{debounce:300})});function watchQueue(t,e,a,r=void 0){const o=watchData.length;e===null&&a===""||a===null&&e===""||(watchData.push({field:t,newValue:e,oldValue:a,index:r}),o===0&&watchListen())}function getWatchField(t,e=!1){let a=t;if(t.indexOf(".*.")>-1){let r=t.split(".*.");e?a=r[1]:a=r[0]}return a}function watchListen(){const t=JSON.parse(JSON.stringify(watchData)).shift();t&&(watchAjax(t.field,t.newValue,t.oldValue,t.index),watchData.shift(),watchListen())}function watchAjax(t,e,a,r){return watchCancel!=null&&watchCancel(),new Promise((o,i)=>{submitPass=!1,st({url:props.url,method:props.method,cancelToken:new $r.CancelToken(function(n){watchCancel=n}),data:Object.assign(props.callParams,{ex_admin_form_action:"watch",originData,data:attrs.model,ex_field:t,newValue:e,oldValue:a,index:r,formField:attrs.formField,id:props.editId},props.params)}).then(n=>{watchCancel=null;let p=n.data.data;for(let s in p){if(Mt(attrs.model[s])){let d=getWatchField(t,!0);for(let u in p[s])try{p[s][u][d]=attrs.model[s][u][d]}catch{}}attrs.model[s]=p[s]}submitPass=!0}).finally(n=>{o(n)})})}props.focusFirst&&ai(()=>{enterNext()});function enterNext(){let t=form.value.$el.querySelectorAll("input,select,textarea");t=Array.from(t).filter(e=>!(e.nodeName=="INPUT"&&e.getAttribute("type")=="hidden")),t.forEach((e,a)=>{document.activeElement===e&&(enterTabIndex=a)}),enterTabIndex<t.length-1?enterTabIndex++:enterTabIndex=0,t[enterTabIndex].focus()}function onEnter(){props.enterToTab&&enterNext()}function submitData(){const t=el.exports.cloneDeep(attrs.model);De(t,props.exceptField);for(let e in t)t[e]===void 0&&(t[e]=null);return t}function scrollToField(t){let e=t.map(a=>rn(a)?"*":a);el.exports.forEach(props.tabsValidateField,function(a){el.exports.forEach(a,function(r,o){e.join(".")==o&&el.exports.forEach(r,function(i){proxyData[i.model]=i.key})})}),el.exports.forEach(props.collapseValidateField,function(a){el.exports.forEach(a,function(r,o){e.join(".")==o&&el.exports.forEach(r,function(i){proxyData[i.model]=i.key})})}),form.value.scrollToField(t,{block:"center",behavior:"smooth"})}function validate(t,e,a){t=t.join("."),e?(props.validateField[t].message=null,props.validateField[t].status=null):(props.validateField[t].status="error",props.validateField[t].message=a)}function clearValidate(){el.exports.forEach(props.validateField,function(t,e){props.validateField[e].message=null,props.validateField[e].status=null})}const submitDebounce=el.exports.debounce(submit,500);function submit(){const t=submitData();emit("submit",t),form.value.validate().then(()=>{if(props.url){if(watchData.length>0||!submitPass){loading.value=!0,setTimeout(()=>{submit()},100);return}let e={ex_admin_form_action:"save",originData,data:t,CURRENT_VALIDATION_STEP:props.stepCurrent,FORM_REF:attrs.form_ref};e.id=props.editId,http({url:props.url,method:props.method,data:Object.assign(props.callParams,e,props.params)}).then(a=>{if(clearValidate(),a.code===422){let r="";for(let o in a.data){r||(r=o);let i=a.data[o];props.validateField[o].status="error",props.validateField[o].message=Array.isArray(i)?i[0]:i}scrollToField([r]);return}else if(a.code===201){emit("update:stepCurrent",props.stepCurrent+1);return}else a.code===202&&(emit("update:stepCurrent",props.stepCurrent+1),stepResult.value=a.data);emit("success",a)})}else emit("success")}).catch(e=>{scrollToField(e.errorFields[0].name)})}function stepReset(){emit("update:stepCurrent",0),form.value.resetFields(),stepResult.value=null}function reset(){form.value.resetFields(),clearValidate()}const context={submitData,submitDebounce,stepReset,form,loading,submit,reset};return hi(context),expose(context),(t,e)=>{const a=$u("render"),r=$u("a-form");return Qs(),Oi(r,uc({class:"form",ref_key:"form",ref:form,onValidate:validate},t.$attrs,{onKeyup:od(onEnter,["native","enter"])}),{default:yi(()=>[Ju(t.$slots,"default",{},void 0,!0),ie(a,{data:stepResult.value},null,8,["data"]),Ju(t.$slots,"footer",{},void 0,!0)]),_:3},16,["onKeyup"])}}});var form=ut(_sfc_main,[["__scopeId","data-v-7d3146b7"]]);export{form as default};
