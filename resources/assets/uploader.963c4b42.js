import{U}from"./simple-uploader.js.2c7eb4f6.js";import{O}from"./ali-oss.176c76b1.js";import{u as P}from"./qiniu-js.8b174ca3.js";import{h as E,j as _,t as f,s as I}from"./index.97aad9ce.js";import"./vue.a928b16e.js";import{r as j}from"./@vue.a7cd1c69.js";import{m as o,n as q}from"./ant-design-vue.e6b3edbc.js";function u(){}function $(r){let p,g;const m=j(),n={onSuccess:u,onError:u,onVerifyProgress:u,onProgress:u,onAddFile:u,onFileSubmit:u};r=Object.assign({action:"",type:"file",accessKey:"",secretKey:"",bucket:"",region:"",directory:"",domain:"",uploadToken:"",chunkSize:1,chunk:!0,disabled:!1,isDirectory:!1,multiple:!1,progress:!1,disk:"local",driver:"local",accept:"",params:{},headers:{},options:{}},r),r.driver==="oss"&&(p=new O({accessKeyId:r.accessKey,accessKeySecret:r.secretKey,bucket:r.bucket,region:r.region}));let t=new U(Object.assign({target:"/"+r.action,query:e=>Object.assign({type:r.type,file_type:e.fileType,directory:r.directory,disk:r.disk},r.params),testChunks:r.chunk,chunkSize:r.chunk?r.chunkSize*1024*1024:10240*1024*1024,headers:Object.assign({Authorization:"Bearer "+E.get()},r.headers),checkChunkUploadedByResponse:r.chunk?function(e,a){let s={};try{s=JSON.parse(a)}catch{}return!!((s.data.uploaded_chunks||[]).indexOf(e.offset+1)>=0||s.data.url)}:null},r.options));t.on("fileAdded",function(e,a){if(n.onAddFile(e,a)===!1)return t.removeFile(e),!1}),t.on("filesSubmitted",function(e,a){if(n.onFileSubmit(e,a)===!1&&t.cancel(),e.forEach(s=>{let i=_(s.file);s.pause(),i.watch({progress:function(c){S(c)},success:function(c){i=null,s.uniqueIdentifier=c,r.driver=="local"||r.type=="image"?s.resume():(r.driver==="oss"?F(s,k(s)):r.driver==="qiniu"&&x(s,k(s)),t.removeFile(s))}})}),t.upload(),r.progress){const s=document.getElementsByClassName("tox-dialog__footer");s.length>0&&o.config({getContainer:()=>s[0]}),g=o.loading({duration:0,prefixCls:s.length>0?"ex-message-upload ant-message":"ant-message",content:function(){return m.value}})}});function k(e){return r.directory+e.uniqueIdentifier+"."+e.getExtension()}t.on("fileProgress",function(e,a,s){y(parseInt(t.progress()*100))}),t.on("fileSuccess",function(e,a,s,i){t.removeFile(a);try{const c=JSON.parse(s);if(c.code===200)a.path=c.data.path,h(a,c.data.url);else{if(c.code===80010)return l(),c.data.type==="success"&&n.onSuccess(),q.open(c.data);if(c.code===80020)return l(),c.data.type==="success"&&n.onSuccess(),o.open(c.data);d(c.message)}}catch{d()}}),t.on("fileError",function(e,a,s,i){t.removeFile(a),d(s)});function b(e){r.disabled||(t.assignDrop(e),t.assignBrowse(e,r.isDirectory,!r.multiple,{accept:r.accept}))}function S(e){m.value=f("Uploader.check")+e+"%",n.onVerifyProgress(e)}function y(e){m.value=f("Uploader.uploading")+e+"%",n.onProgress(e)}function l(){g&&(g(),o.destroy(),o.config({getContainer:()=>document.body}))}function h(e,a){l(),I({url:"/ex-admin/system/upload",method:"post",data:{data:{cate_id:r.params.cate_id||0,type:e.fileType.indexOf("image")===0?"image":"file",name:e.uniqueIdentifier+"."+e.getExtension(),real_name:e.name,file_type:e.fileType,url:a,ext:e.getExtension(),disk:r.disk,path:e.path,size:e.getSize()}}}).then(s=>{r.progress&&o.success(f("Uploader.success")),n.onSuccess(a)})}function d(e){l(),e||(e=f("Uploader.error")),o.error(e),n.onError(e)}function v(e){e.addFile&&(n.onAddFile=e.addFile),e.onFileSubmit&&(n.onAddFile=e.fileSubmit),e.success&&(n.onSuccess=e.success),e.error&&(n.onError=e.error),e.verifyProgress&&(n.onVerifyProgress=e.verifyProgress),e.progress&&(n.onProgress=e.progress)}function F(e,a){p.multipartUpload(a,e.file,{progress:function(s){y(parseInt(s*100))}}).then(s=>{const i=`${r.domain}/${a}`;e.path=a,h(e,i)}).catch(s=>{d(s.message)})}function x(e,a){P(e.file,a,r.uploadToken,{fname:a}).subscribe({next(i){y(parseInt(i.total.percent))},error(i){d(i.message)},complete:()=>{e.path=a;const i=`${r.domain}/${a}`;h(e,i)}})}return{uploader:t,watch:v,options:r,input:b}}export{$ as u};
