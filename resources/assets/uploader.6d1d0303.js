import{U as P}from"./simple-uploader.js.f8a4d47a.js";import{O as _}from"./ali-oss.fc1e842f.js";import{u as E}from"./qiniu-js.8b174ca3.js";import{g as U,h as O,t as l,s as A}from"./index.9a3c7168.js";import"./vue.f169bc0e.js";import{r as I}from"./@vue.a2bdcbc4.js";import{m as o}from"./ant-design-vue.e653cb26.js";function u(){}function N(r){let y,f;const g=I(),n={onSuccess:u,onError:u,onVerifyProgress:u,onProgress:u,onAddFile:u,onFileSubmit:u};r=Object.assign({action:"",type:"file",accessKey:"",secretKey:"",bucket:"",region:"",directory:"",domain:"",uploadToken:"",chunkSize:1,chunk:!0,disabled:!1,isDirectory:!1,multiple:!1,progress:!1,disk:"local",driver:"local",accept:"",params:{},headers:{},options:{}},r),r.driver==="oss"&&(y=new _({accessKeyId:r.accessKey,accessKeySecret:r.secretKey,bucket:r.bucket,region:r.region}));let t=new P(Object.assign({target:{}.VITE_APP_BASE_API+r.action,query:e=>Object.assign({type:r.type,file_type:e.fileType,directory:r.directory,disk:r.disk},r.params),testChunks:r.chunk,chunkSize:r.chunk?r.chunkSize*1024*1024:10240*1024*1024,headers:Object.assign({Authorization:"Bearer "+U.get()},r.headers),checkChunkUploadedByResponse:function(e,a){let s={};try{s=JSON.parse(a)}catch{}return!!((s.data.uploaded_chunks||[]).indexOf(e.offset+1)>=0||s.data.url)}},r.options));t.on("fileAdded",function(e,a){if(n.onAddFile(e,a)===!1)return t.removeFile(e),!1}),t.on("filesSubmitted",function(e,a){if(n.onFileSubmit(e,a)===!1&&t.cancel(),e.forEach(s=>{let c=O(s.file);s.pause(),c.watch({progress:function(i){v(i)},success:function(i){c=null,s.uniqueIdentifier=i,r.driver=="local"||r.type=="image"?s.resume():(r.driver==="oss"?F(s,p(s)):r.driver==="qiniu"&&x(s,p(s)),t.removeFile(s))}})}),t.upload(),r.progress){const s=document.getElementsByClassName("tox-dialog__footer");s.length>0&&o.config({getContainer:()=>s[0]}),f=o.loading({duration:0,prefixCls:s.length>0?"ex-message-upload ant-message":"ant-message",content:function(){return g.value}})}});function p(e){return r.directory+e.uniqueIdentifier+"."+e.getExtension()}t.on("fileProgress",function(e,a,s){m(parseInt(t.progress()*100))}),t.on("fileSuccess",function(e,a,s,c){try{const i=JSON.parse(s);i.code==200?(t.removeFile(a),a.path=i.data.path,h(a,i.data.url)):d(i.message)}catch{d()}}),t.on("fileError",function(e,a,s,c){t.removeFile(a),d(s)});function b(e){r.disabled||(t.assignDrop(e),t.assignBrowse(e,r.isDirectory,!r.multiple,{accept:r.accept}))}function v(e){g.value=l("Uploader.check")+e+"%",n.onVerifyProgress(e)}function m(e){g.value=l("Uploader.uploading")+e+"%",n.onProgress(e)}function k(){f&&(f(),o.destroy(),o.config({getContainer:()=>document.body}))}function h(e,a){k(),A({url:"/ex-admin/system/upload",method:"post",data:{data:{cate_id:r.params.cate_id||0,type:e.fileType.indexOf("image")===0?"image":"file",name:e.uniqueIdentifier+"."+e.getExtension(),real_name:e.name,file_type:e.fileType,url:a,ext:e.getExtension(),disk:r.disk,path:e.path,size:e.getSize()}}}).then(s=>{r.progress&&o.success(l("Uploader.success")),n.onSuccess(a)})}function d(e){k(),e||(e=l("Uploader.error")),o.error(e),n.onError(e)}function S(e){e.addFile&&(n.onAddFile=e.addFile),e.onFileSubmit&&(n.onAddFile=e.fileSubmit),e.success&&(n.onSuccess=e.success),e.error&&(n.onError=e.error),e.verifyProgress&&(n.onVerifyProgress=e.verifyProgress),e.progress&&(n.onProgress=e.progress)}function F(e,a){y.multipartUpload(a,e.file,{progress:function(s){m(parseInt(s*100))}}).then(s=>{const c=`${r.domain}/${a}`;e.path=a,h(e,c)}).catch(s=>{d(s.message)})}function x(e,a){E(e.file,a,r.uploadToken,{fname:a}).subscribe({next(c){m(parseInt(c.total.percent))},error(c){d(c.message)},complete:()=>{e.path=a;const c=`${r.domain}/${a}`;h(e,c)}})}return{uploader:t,watch:S,options:r,input:b}}export{N as u};
